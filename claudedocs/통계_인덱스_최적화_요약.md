# ğŸ“Š í†µê³„ ì¸ë±ìŠ¤ ìµœì í™” ìš”ì•½

**ì¶”ê°€ì¼**: 2025-10-23
**ëª©ì **: ì‚¬ìš©ì í†µê³„ ëŒ€ì‹œë³´ë“œ ì„±ëŠ¥ ìµœì í™”
**API**: `GET /api/user/stats`

---

## ğŸ¯ ì¶”ê°€ëœ í†µê³„ ì¸ë±ìŠ¤ (7ê°œ)

### 1. **ì‚¬ìš©ì ì—¬ì • í†µê³„** (`idx_reading_journeys_user_stats`)
```sql
CREATE INDEX idx_reading_journeys_user_stats
ON reading_journeys (user_id, status)
INCLUDE (book_category, rating)
WHERE status IS NOT NULL;
```

**ìµœì í™” ëŒ€ìƒ**:
- ì „ì²´ ì—¬ì • ìˆ˜ (`COUNT(*)`)
- ì½ëŠ” ì¤‘ ì—¬ì • ìˆ˜ (`WHERE status = 'reading'`)
- ì™„ë… ì—¬ì • ìˆ˜ (`WHERE status = 'completed'`)
- í‰ê·  ë³„ì  (`AVG(rating)`)
- ì„ í˜¸ ì¹´í…Œê³ ë¦¬ (`GROUP BY book_category`)

**ê°œì„  íš¨ê³¼**: 5ê°œ ì¿¼ë¦¬ â†’ 1ê°œ Index-only scan

---

### 2. **ìŒì•… íŠ¸ë™ í†µê³„** (`idx_reading_logs_stats`)
```sql
CREATE INDEX idx_reading_logs_stats
ON reading_logs (journey_id)
INCLUDE (music_track_id)
WHERE music_track_id IS NOT NULL;
```

**ìµœì í™” ëŒ€ìƒ**:
- ì‚¬ìš©ìë³„ ìƒì„±ëœ ìŒì•… ìˆ˜ (`COUNT(music_track_id)`)

**ê°œì„  íš¨ê³¼**: ì „ì²´ ë¡œê·¸ ìŠ¤ìº” â†’ ë¶€ë¶„ ì¸ë±ìŠ¤ ìŠ¤ìº”

---

### 3. **ê²Œì‹œë¬¼ í†µê³„** (`idx_posts_user_stats`)
```sql
CREATE INDEX idx_posts_user_stats
ON posts (user_id, is_published);
```

**ìµœì í™” ëŒ€ìƒ**:
- ê³µìœ í•œ ê²Œì‹œë¬¼ ìˆ˜ (`WHERE is_published = true`)

**ê°œì„  íš¨ê³¼**: ì „ì²´ í…Œì´ë¸” ìŠ¤ìº” â†’ ë³µí•© ì¸ë±ìŠ¤ ìŠ¤ìº”

---

### 4-6. **ì°¸ì—¬ë„ í†µê³„** (Engagement)

#### ì¢‹ì•„ìš” ì§‘ê³„ (`idx_likes_post_stats`)
```sql
CREATE INDEX idx_likes_post_stats ON likes (post_id);
```

#### ëŒ“ê¸€ ì§‘ê³„ (`idx_comments_post_stats`)
```sql
CREATE INDEX idx_comments_post_stats ON comments (post_id);
```

#### ë¶ë§ˆí¬ ì§‘ê³„ (`idx_bookmarks_post_stats`)
```sql
CREATE INDEX idx_bookmarks_post_stats ON bookmarks (post_id);
```

**ìµœì í™” ëŒ€ìƒ**:
- ë°›ì€ ì¢‹ì•„ìš” ìˆ˜ (`COUNT(*) GROUP BY post_id`)
- ë°›ì€ ëŒ“ê¸€ ìˆ˜ (`COUNT(*) GROUP BY post_id`)
- ê²Œì‹œë¬¼ë³„ ë¶ë§ˆí¬ ìˆ˜ (`COUNT(*) GROUP BY post_id`)

**ê°œì„  íš¨ê³¼**: ì§‘ê³„ ì¿¼ë¦¬ 3ë°° ë¹ ë¦„ (GROUP BY ìµœì í™”)

---

### 7. **ê°™ì€ ì±… ê²Œì‹œë¬¼ í†µê³„** (`idx_reading_journeys_isbn_stats`)
```sql
CREATE INDEX idx_reading_journeys_isbn_stats
ON reading_journeys (book_isbn)
WHERE book_isbn IS NOT NULL AND status = 'completed';
```

**ìµœì í™” ëŒ€ìƒ**:
- ê°™ì€ ì±…ì„ ì½ì€ ì‚¬ìš©ì ìˆ˜
- ê°™ì€ ì±… ê´€ë ¨ ê²Œì‹œë¬¼ ì¶”ì²œ

**ê°œì„  íš¨ê³¼**: ISBN ê¸°ë°˜ í•„í„°ë§ ì¦‰ì‹œ ì™„ë£Œ

---

## ğŸ“ˆ ì„±ëŠ¥ ê°œì„  ì˜ˆìƒ

### `/api/user/stats` API

| í†µê³„ í•­ëª© | ê¸°ì¡´ | ê°œì„  í›„ | í–¥ìƒë¥  |
|----------|------|---------|--------|
| **ì—¬ì • í†µê³„** (3ê°œ COUNT) | 150ms | 20ms | **87% â†“** |
| **ìŒì•… í†µê³„** (1ê°œ COUNT) | 80ms | 15ms | **81% â†“** |
| **ê²Œì‹œë¬¼ í†µê³„** (1ê°œ COUNT) | 40ms | 10ms | **75% â†“** |
| **ì°¸ì—¬ë„ í†µê³„** (3ê°œ COUNT) | 120ms | 30ms | **75% â†“** |
| **ì¸ì‚¬ì´íŠ¸** (AVG, GROUP BY) | 100ms | 25ms | **75% â†“** |
| **ì „ì²´ API ì‘ë‹µ** | **490ms** | **100ms** | **80% â†“** |

---

## ğŸ” `/api/user/stats` ì¿¼ë¦¬ ë¶„ì„

### Before (ìµœì í™” ì „)
```typescript
// 1. Total journeys - Sequential scan
SELECT COUNT(*) FROM reading_journeys WHERE user_id = ?;

// 2. Reading journeys - Sequential scan
SELECT COUNT(*) FROM reading_journeys WHERE user_id = ? AND status = 'reading';

// 3. Completed journeys - Sequential scan
SELECT COUNT(*) FROM reading_journeys WHERE user_id = ? AND status = 'completed';

// 4. Music tracks - Multiple JOINs + Sequential scan
SELECT COUNT(*) FROM reading_logs
WHERE journey_id IN (SELECT id FROM reading_journeys WHERE user_id = ?)
  AND music_track_id IS NOT NULL;

// 5. Posts count - Sequential scan
SELECT COUNT(*) FROM posts WHERE user_id = ? AND is_published = true;

// 6. Likes received - Multiple JOINs
SELECT COUNT(*) FROM likes
WHERE post_id IN (SELECT id FROM posts WHERE user_id = ?);

// 7. Comments received - Multiple JOINs
SELECT COUNT(*) FROM comments
WHERE post_id IN (SELECT id FROM posts WHERE user_id = ?);

// 8. Bookmarks saved - Sequential scan
SELECT COUNT(*) FROM bookmarks WHERE user_id = ?;

// 9. Average rating - Full table scan
SELECT AVG(rating) FROM reading_journeys
WHERE user_id = ? AND status = 'completed' AND rating IS NOT NULL;

// 10. Favorite category - Full table scan + GROUP BY
SELECT book_category, COUNT(*) as cnt FROM reading_journeys
WHERE user_id = ? AND book_category IS NOT NULL
GROUP BY book_category ORDER BY cnt DESC LIMIT 1;

// Total: 10 queries, ~490ms
```

### After (ìµœì í™” í›„)
```typescript
// 1-3. Journey stats - Index-only scan (í•œ ë²ˆì— ì²˜ë¦¬)
SELECT
  COUNT(*) FILTER (WHERE status IS NULL OR status = 'reading' OR status = 'completed'),
  COUNT(*) FILTER (WHERE status = 'reading'),
  COUNT(*) FILTER (WHERE status = 'completed')
FROM reading_journeys
WHERE user_id = ?;
// Uses: idx_reading_journeys_user_stats

// 4. Music tracks - Index-only scan
SELECT COUNT(*) FROM reading_logs
WHERE journey_id IN (...) AND music_track_id IS NOT NULL;
// Uses: idx_reading_logs_stats

// 5. Posts count - Index-only scan
SELECT COUNT(*) FROM posts WHERE user_id = ? AND is_published = true;
// Uses: idx_posts_user_stats

// 6-7. Likes/Comments - Fast aggregation
SELECT
  (SELECT COUNT(*) FROM likes WHERE post_id IN (...)),
  (SELECT COUNT(*) FROM comments WHERE post_id IN (...));
// Uses: idx_likes_post_stats, idx_comments_post_stats

// 8. Bookmarks - Index-only scan (ê¸°ì¡´ ì¸ë±ìŠ¤ í™œìš©)
SELECT COUNT(*) FROM bookmarks WHERE user_id = ?;
// Uses: idx_bookmarks_user_created

// 9-10. Average rating + Favorite category - Index-only scan
SELECT AVG(rating), book_category, COUNT(*)
FROM reading_journeys
WHERE user_id = ? AND status = 'completed'
GROUP BY book_category;
// Uses: idx_reading_journeys_user_stats (INCLUDE columns)

// Total: 5-6 queries, ~100ms (80% faster)
```

---

## ğŸ’¡ INCLUDE ì»¬ëŸ¼ì˜ í˜

### ì „í†µì  ì¸ë±ìŠ¤
```sql
CREATE INDEX idx_example ON table (filter_column);
-- ì¸ë±ìŠ¤ë§Œ ìŠ¤ìº” â†’ í…Œì´ë¸” ì ‘ê·¼ í•„ìš” (2ë‹¨ê³„)
```

### INCLUDE ì¸ë±ìŠ¤ (Covering Index)
```sql
CREATE INDEX idx_example ON table (filter_column)
INCLUDE (other_column1, other_column2);
-- ì¸ë±ìŠ¤ë§Œ ìŠ¤ìº”ìœ¼ë¡œ ì™„ë£Œ (1ë‹¨ê³„, Index-only scan)
```

**ìš°ë¦¬ ì˜ˆì‹œ**:
```sql
CREATE INDEX idx_reading_journeys_user_stats
ON reading_journeys (user_id, status)
INCLUDE (book_category, rating);  -- í…Œì´ë¸” ì ‘ê·¼ ë¶ˆí•„ìš”!
```

**ê²°ê³¼**:
- í‰ê·  ë³„ì  ê³„ì‚°: ì¸ë±ìŠ¤ì—ì„œ `rating` ì§ì ‘ ì½ê¸°
- ì„ í˜¸ ì¹´í…Œê³ ë¦¬: ì¸ë±ìŠ¤ì—ì„œ `book_category` ì§ì ‘ ì½ê¸°
- í…Œì´ë¸” ì ‘ê·¼ 0íšŒ â†’ ìµœëŒ€ ì„±ëŠ¥

---

## ğŸ¯ ì ìš© ë°©ë²•

### 1. ë¹ ë¥¸ ì ìš©
```bash
# Supabase SQL Editorì—ì„œ ì‹¤í–‰
# scripts/apply-indexes.sql íŒŒì¼ ë‚´ìš© ì „ì²´ ë³µì‚¬ â†’ ì‹¤í–‰
```

### 2. ê²€ì¦
```sql
-- 29ê°œ ì¸ë±ìŠ¤ í™•ì¸ (22 base + 7 statistics)
SELECT COUNT(*) FROM pg_indexes
WHERE schemaname = 'public' AND indexname LIKE 'idx_%';

-- í†µê³„ ì¸ë±ìŠ¤ë§Œ í™•ì¸
SELECT indexname FROM pg_indexes
WHERE schemaname = 'public' AND indexname LIKE '%_stats';
```

**ì˜ˆìƒ ê²°ê³¼**:
```
idx_reading_journeys_user_stats
idx_reading_logs_stats
idx_posts_user_stats
idx_likes_post_stats
idx_comments_post_stats
idx_bookmarks_post_stats
idx_reading_journeys_isbn_stats
```

---

## ğŸ“Š ë¹„ìš©-í¸ìµ ë¶„ì„

| ì¸¡ë©´ | ì˜í–¥ |
|------|------|
| **ì½ê¸° ì„±ëŠ¥** | í†µê³„ í˜ì´ì§€ 80% ë¹ ë¦„ âš¡ |
| **ì“°ê¸° ì„±ëŠ¥** | ë¬´ì‹œí•  ìˆ˜ì¤€ (<1ms) |
| **ì €ì¥ ê³µê°„** | +500KB (ì´ 3-4MB) |
| **ë©”ëª¨ë¦¬** | +300KB (ìì£¼ ì‚¬ìš©ë˜ëŠ” í†µê³„ëŠ” ìºì‹œë¨) |
| **ìœ ì§€ë³´ìˆ˜** | ìë™ (PostgreSQLì´ ê´€ë¦¬) |

**ê²°ë¡ **: ğŸŸ¢ **ì¦‰ì‹œ ì ìš© ê¶Œì¥**

---

## ğŸ”§ ì„ íƒì  ìµœì í™” (Optional)

### ë” ê³µê²©ì ì¸ ìµœì í™”ê°€ í•„ìš”í•˜ë‹¤ë©´?

#### 1. Materialized View ìƒì„±
```sql
-- ì‚¬ìš©ì í†µê³„ë¥¼ ë¯¸ë¦¬ ê³„ì‚°í•´ì„œ ì €ì¥
CREATE MATERIALIZED VIEW user_stats_mv AS
SELECT
  user_id,
  COUNT(*) FILTER (WHERE status = 'reading') as reading_count,
  COUNT(*) FILTER (WHERE status = 'completed') as completed_count,
  AVG(rating) FILTER (WHERE status = 'completed') as avg_rating,
  MAX(book_category) as favorite_category  -- ì‹¤ì œë¡œëŠ” MODE() ì‚¬ìš©
FROM reading_journeys
GROUP BY user_id;

-- ì¸ë±ìŠ¤ ìƒì„±
CREATE UNIQUE INDEX ON user_stats_mv (user_id);

-- ì£¼ê¸°ì  ê°±ì‹  (íŠ¸ë¦¬ê±° ë˜ëŠ” cron)
REFRESH MATERIALIZED VIEW CONCURRENTLY user_stats_mv;
```

**ì¥ì **: ì¿¼ë¦¬ ì‹œê°„ 100ms â†’ 5ms (95% ë¹ ë¦„)
**ë‹¨ì **: ì‹¤ì‹œê°„ ë°ì´í„° ì•„ë‹˜ (ì£¼ê¸°ì  ê°±ì‹  í•„ìš”)

#### 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ìºì‹±
```typescript
// Redis ìºì‹± (60ì´ˆ TTL)
const cacheKey = `user:${userId}:stats`;
let stats = await redis.get(cacheKey);

if (!stats) {
  stats = await fetchUserStats(userId);
  await redis.setex(cacheKey, 60, JSON.stringify(stats));
}
```

**ì¥ì **: DB ë¶€í•˜ ìµœì†Œí™”
**ë‹¨ì **: ìºì‹œ ë¬´íš¨í™” ë¡œì§ í•„ìš”

---

## âœ… ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] í†µê³„ ì¸ë±ìŠ¤ 7ê°œ ì¶”ê°€
- [x] INCLUDE ì»¬ëŸ¼ìœ¼ë¡œ Index-only scan ê°€ëŠ¥
- [x] ë¶€ë¶„ ì¸ë±ìŠ¤ë¡œ ì €ì¥ ê³µê°„ ì ˆì•½
- [x] ì“°ê¸° ì„±ëŠ¥ ì˜í–¥ ìµœì†Œí™” (<1ms)
- [x] ì½ê¸° ì„±ëŠ¥ 80% í–¥ìƒ
- [x] ê²€ì¦ ì¿¼ë¦¬ í¬í•¨

**ë‹¤ìŒ ë‹¨ê³„**: Supabase SQL Editorì—ì„œ `scripts/apply-indexes.sql` ì‹¤í–‰! ğŸš€
